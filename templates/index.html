<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BossHub Threat Hunter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #1a1d20; color: #e0e0e0; font-family: 'Courier New', Courier, monospace; }
        .card { background-color: #2c3034; border: 1px solid #495057; }
        .card-header { background-color: #212529; border-bottom: 1px solid #495057; font-weight: bold; }
        .text-neon-green { color: #00ff41; }
        .text-neon-red { color: #ff3838; }
        .table-dark { --bs-table-bg: #2c3034; }
        pre { background: #000; color: #0f0; padding: 10px; border-radius: 5px; border: 1px solid #333; }
        .badge-danger-glow { background-color: #dc3545; box-shadow: 0 0 10px #dc3545; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-black border-bottom border-secondary mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1 text-neon-green">
            <i class="bi bi-radioactive"></i> BossHub Threat Hunter & Server Guard
        </span>
        <span class="text-white small">System: <span id="sysInfo">Loading...</span></span>
    </div>
</nav>

<div class="container-fluid px-4">
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-activity"></i> Active Network Threats & Mining Connections</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="scanNetwork()">
                        <i class="bi bi-arrow-repeat"></i> Scan Connections
                    </button>
                </div>
                <div class="card-body">
                    <div id="networkAlert" class="alert alert-dark d-none"></div>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-sm small">
                            <thead>
                                <tr class="text-secondary">
                                    <th>PID/Program</th>
                                    <th>Local Address</th>
                                    <th>Remote Address (Destination)</th>
                                    <th>Status</th>
                                    <th>Risk Level</th>
                                    <th>Threat Details</th>
                                </tr>
                            </thead>
                            <tbody id="networkTableBody">
                                <tr><td colspan="6" class="text-center text-muted">Click "Scan Connections" to start...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-danger">
                <div class="card-header text-danger">
                    <i class="bi bi-bug-fill"></i> HestiaCP/VestaCP Web Shell & Injection Scanner
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        ระบบจะสแกนหาไฟล์ .php, .py, .sh ในโฟลเดอร์ <code>/home</code> เพื่อหาคำสั่งอันตราย เช่น 
                        <code>eval()</code>, <code>base64_decode</code>, <code>xmrig</code>
                    </p>
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-dark text-light border-secondary">Path to Scan</span>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="scanPath" value="/home">
                        <button class="btn btn-danger" onclick="scanHosting()">
                            <i class="bi bi-search"></i> Start Deep Scan
                        </button>
                    </div>

                    <div id="malwareProgress" class="d-none text-center py-3">
                        <div class="spinner-border text-danger" role="status"></div>
                        <span class="ms-2 text-danger">กำลังสแกนไฟล์นับพันไฟล์... (อาจใช้เวลา 10-30 วินาที)</span>
                    </div>

                    <div id="malwareResultArea" class="d-none">
                        <h6 class="text-white">Scan Result: พบความเสี่ยง <span id="infectedCount" class="badge bg-danger">0</span> ไฟล์ (จาก <span id="scannedCount">0</span> ไฟล์)</h6>
                        <div class="table-responsive mt-2">
                            <table class="table table-dark table-bordered border-danger small">
                                <thead>
                                    <tr>
                                        <th>File Path</th>
                                        <th>Modified Date</th>
                                        <th>Threat Signature Detected</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="malwareTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const API_PORT = 8989;
    const BASE_URL = `http://${window.location.hostname}:${API_PORT}/api`;
    const AUTH = 'Basic ' + btoa('root:BossHubRoot');

    async function apiCall(endpoint) {
        const res = await fetch(endpoint, { headers: { 'Authorization': AUTH } });
        if(res.status === 401) { alert("Authentication Failed!"); return null; }
        return await res.json();
    }

    // --- Network Scan ---
    async function scanNetwork() {
        const tbody = document.getElementById('networkTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Scanning active connections...</td></tr>';
        
        try {
            const res = await apiCall(`${BASE_URL}/scan/network_threats`);
            tbody.innerHTML = '';
            
            if(res.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-success"><i class="bi bi-shield-check"></i> No active threats detected in connections.</td></tr>';
                return;
            }

            res.data.forEach(conn => {
                const isDanger = conn.risk_score > 0;
                const rowClass = isDanger ? 'table-danger' : '';
                const badge = isDanger ? 
                    `<span class="badge badge-danger-glow">HIGH RISK (${conn.risk_score})</span>` : 
                    `<span class="badge bg-secondary">Normal</span>`;
                
                const row = `
                    <tr class="${rowClass}">
                        <td><strong>${conn.pid}</strong> : ${conn.program}</td>
                        <td>${conn.laddr}</td>
                        <td class="text-warning">${conn.raddr}</td>
                        <td>${conn.status}</td>
                        <td>${badge}</td>
                        <td>${conn.reasons || '-'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch(e) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-danger">Error: ${e.message}</td></tr>`;
        }
    }

    // --- Hosting/Malware Scan ---
    async function scanHosting() {
        const path = document.getElementById('scanPath').value;
        const progress = document.getElementById('malwareProgress');
        const resultArea = document.getElementById('malwareResultArea');
        const tbody = document.getElementById('malwareTableBody');
        
        progress.classList.remove('d-none');
        resultArea.classList.add('d-none');
        
        try {
            const res = await apiCall(`${BASE_URL}/scan/hosting_malware?path=${path}`);
            
            document.getElementById('scannedCount').textContent = res.scanned_count;
            document.getElementById('infectedCount').textContent = res.infected_count;
            
            tbody.innerHTML = '';
            if(res.infected_count > 0) {
                res.details.forEach(file => {
                    const row = `
                        <tr>
                            <td class="text-break font-monospace text-warning">${file.path}</td>
                            <td>${file.modified}</td>
                            <td class="text-danger">${file.threats.join('<br>')}</td>
                            <td><button class="btn btn-sm btn-outline-light" onclick="alert('กรุณาเข้าไปลบหรือตรวจสอบไฟล์นี้ผ่าน SSH ทันที: ${file.path}')">Inspect</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success">Clean! ไม่พบ Signature อันตรายในไฟล์ที่สแกน</td></tr>';
            }
            
            resultArea.classList.remove('d-none');

        } catch(e) {
            alert("Error scanning malware: " + e.message);
        } finally {
            progress.classList.add('d-none');
        }
    }

    // --- Init ---
    (async function init() {
        const stats = await apiCall(`${BASE_URL}/server/quick_stats`);
        if(stats) document.getElementById('sysInfo').textContent = `${stats.os} | CPU: ${stats.cpu_percent}%`;
    })();

</script>
</body>
</html>
