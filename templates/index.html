<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BossHub Server Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .scanner-card { 
            max-width: 800px; 
            margin: 50px auto; 
            box-shadow: 0 4px 8px rgba(0,0,0,.05); 
        }
        pre { 
            background-color: #f1f1f1; 
            padding: 15px; 
            border-radius: 5px; 
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card scanner-card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">BossHub Server Security Scanner</h4>
        </div>
        <div class="card-body">
            <p class="text-muted">โปรดระบุ IP Address หรือ Domain Name ของเซิร์ฟเวอร์ที่คุณต้องการสแกน (เช่น 127.0.0.1)</p>
            
            <form id="scanForm">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="targetInput" placeholder="IP Address หรือ Domain Name" required>
                    <button class="btn btn-success" type="submit" id="scanBtn">
                        <span id="btnText">สแกนความปลอดภัยภายนอก</span>
                        <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
            
            <hr>
            
            <div id="resultContainer" class="mt-4 d-none">
                <h5>ผลการสแกนสำหรับ: <span id="targetName" class="text-primary"></span></h5>
                <div id="scanResults">
                    </div>
            </div>
            
            <button class="btn btn-outline-info btn-sm mt-3" type="button" onclick="runInternalCheck()">
                ตรวจสอบสถานะภายใน (Users, Processes, Crypto-Mining)
            </button>

        </div>
    </div>
</div>

<script>
    const API_HOST = window.location.hostname;
    // API_URL ชี้ไปที่ Backend Python/Flask ที่รันบนพอร์ต 5000 (ตามที่เราตั้งค่าใน systemd)
    const EXTERNAL_API_URL = `http://${API_HOST}:5000/api/scan/external`; 
    const INTERNAL_API_URL = `http://${API_HOST}:5000/api/scan/internal`; 
    
    const form = document.getElementById('scanForm');
    const targetInput = document.getElementById('targetInput');
    const resultContainer = document.getElementById('resultContainer');
    const scanResults = document.getElementById('scanResults');
    const targetName = document.getElementById('targetName');
    const scanBtn = document.getElementById('scanBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');

    // Helper function to toggle button state
    function toggleButton(isScanning) {
        scanBtn.disabled = isScanning;
        if (isScanning) {
            btnText.textContent = 'กำลังสแกน...';
            spinner.classList.remove('d-none');
        } else {
            btnText.textContent = 'สแกนความปลอดภัยภายนอก';
            spinner.classList.add('d-none');
        }
    }

    // --- External Scan Logic ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const target = targetInput.value.trim();
        if (!target) return;

        targetName.textContent = target;
        scanResults.innerHTML = '<p class="text-warning">การสแกนอาจใช้เวลา โปรดรอสักครู่...</p>';
        resultContainer.classList.remove('d-none');
        toggleButton(true);

        try {
            const response = await fetch(EXTERNAL_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target: target })
            });

            const data = await response.json();
            
            if (!response.ok) {
                scanResults.innerHTML = `<div class="alert alert-danger"><strong>API Error:</strong> ${data.error || 'Unknown Error'}</div>`;
                return;
            }

            // Render results
            scanResults.innerHTML = formatExternalResults(data);

        } catch (error) {
            scanResults.innerHTML = `<div class="alert alert-danger"><strong>Connection Error:</strong> ไม่สามารถเชื่อมต่อกับ Backend API (${EXTERNAL_API_URL}) ได้ โปรดตรวจสอบว่า service รันอยู่</div>`;
            console.error('Fetch error:', error);
        } finally {
            toggleButton(false);
        }
    });

    // --- Internal Check Logic ---
    async function runInternalCheck() {
        targetName.textContent = API_HOST;
        scanResults.innerHTML = '<p class="text-warning">กำลังตรวจสอบสถานะภายใน...</p>';
        resultContainer.classList.remove('d-none');

        try {
            const response = await fetch(INTERNAL_API_URL, { method: 'GET' });
            const data = await response.json();

            if (!response.ok) {
                scanResults.innerHTML = `<div class="alert alert-danger"><strong>API Error:</strong> ${data.error || 'Unknown Error'}</div>`;
                return;
            }

            scanResults.innerHTML = formatInternalResults(data);

        } catch (error) {
            scanResults.innerHTML = `<div class="alert alert-danger"><strong>Connection Error:</strong> ไม่สามารถเชื่อมต่อกับ Backend API (${INTERNAL_API_URL}) ได้ โปรดตรวจสอบว่า service รันอยู่</div>`;
            console.error('Fetch error:', error);
        }
    }


    // --- Result Formatting Functions ---

    function formatExternalResults(data) {
        let html = '';
        
        // Host Status
        const hostStatus = Object.values(data)[0]; 
        const status = hostStatus.status === 'up' ? 
            `<span class="badge bg-success">ONLINE (Host State: ${hostStatus.status})</span>` : 
            `<span class="badge bg-danger">OFFLINE (Host State: ${hostStatus.status})</span>`;
            
        html += `<h6>สถานะเซิร์ฟเวอร์: ${status}</h6>`;
        
        // Ports and Services
        if (hostStatus.ports && hostStatus.ports.length > 0) {
            html += `<h6 class="mt-3">1. & 5. ตรวจสอบ Port และ Service ที่เปิดอยู่</h6>`;
            html += `<table class="table table-sm table-striped"><thead><tr><th>Port</th><th>State</th><th>Service</th><th>Product / Version</th></tr></thead><tbody>`;
            hostStatus.ports.forEach(p => {
                html += `<tr>
                    <td><strong>${p.port}</strong></td>
                    <td><span class="badge ${p.state === 'open' ? 'bg-success' : 'bg-warning'}">${p.state}</span></td>
                    <td>${p.service}</td>
                    <td>${p.product} ${p.version}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
        } else {
            html += `<div class="alert alert-info mt-3">ไม่พบ Port ที่เปิดอยู่ หรือ Host ปิดอยู่</div>`;
        }

        // Security Headers
        if (hostStatus.security_headers && hostStatus.security_headers.length > 0) {
            html += `<h6 class="mt-3">4. ตรวจสอบ Security Headers (เบื้องต้น)</h6>`;
            html += `<pre>${hostStatus.security_headers.join('\n')}</pre>`;
        }
        
        return html;
    }

    function formatInternalResults(data) {
        let html = '';

        // 2. User Check
        html += `<h6 class="mt-3">2. ตรวจสอบ User ที่ล็อกอินอยู่</h6>`;
        if (data.logged_in_users && data.logged_in_users.length > 0) {
            html += `<pre>${data.logged_in_users.join('\n')}</pre>`;
        } else {
             html += `<div class="alert alert-success">ไม่พบ User ที่ล็อกอินอยู่ขณะนี้</div>`;
        }

        // 3. Cryptominer Check
        html += `<h6 class="mt-3">3. ตรวจสอบการแอบขุดบิตคอยน์ (การใช้ CPU สูง)</h6>`;
        if (data.high_cpu_processes && data.high_cpu_processes.length > 0) {
            html += `<div class="alert alert-warning"><strong>พบ Process ใช้ CPU สูงผิดปกติ!</strong> ตรวจสอบ:`;
            html += `<table class="table table-sm mt-2"><thead><tr><th>PID</th><th>Process Name</th><th>CPU %</th><th>Type</th></tr></thead><tbody>`;
            data.high_cpu_processes.forEach(p => {
                html += `<tr class="${p.type === 'Potential Miner' ? 'table-danger' : ''}">
                    <td>${p.pid}</td>
                    <td>${p.name}</td>
                    <td>${p.cpu_percent}%</td>
                    <td>${p.type}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            html += `<div class="alert alert-success">ไม่พบ Process ที่ใช้ CPU สูงผิดปกติในขณะนี้</div>`;
        }

        // 6. Dangerous File Note
        html += `<h6 class="mt-3">6. ตรวจสอบไฟล์อันตราย</h6>`;
        html += `<div class="alert alert-info">${data.security_note}</div>`;

        return html;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
