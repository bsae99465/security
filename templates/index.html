<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BossHub Server Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .scanner-card { 
            max-width: 800px; 
            margin: 50px auto; 
            box-shadow: 0 4px 8px rgba(0,0,0,.05); 
        }
        pre { 
            background-color: #f1f1f1; 
            padding: 15px; 
            border-radius: 5px; 
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card scanner-card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">BossHub Server Security Scanner & Manager</h4>
        </div>
        <div class="card-body">
            <p class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡∏ö‡∏ô **Port 8989** | ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢ **root:BossHubRoot**</p>
            
            <form id="scanForm">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="targetInput" placeholder="IP Address ‡∏´‡∏£‡∏∑‡∏≠ Domain Name ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Full Port Scan (1-65535)" required>
                    <button class="btn btn-success" type="submit" id="scanBtn">
                        <span id="btnText">‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (Full Scan)</span>
                        <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
            
            <hr>
            
            <button class="btn btn-outline-info btn-sm mt-3" type="button" onclick="runInternalCheck()">
                ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Users, Processes, Crypto-Mining)
            </button>
            
            <hr class="mt-4">
            <div class="card bg-light p-3">
                <h6>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Systemd Service</h6>
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="serviceNameInput" placeholder="Service Name (‡πÄ‡∏ä‡πà‡∏ô nginx, sshd, server_scanner)">
                    <button class="btn btn-sm btn-info" onclick="manageService('status')">Status</button>
                    <button class="btn btn-sm btn-success" onclick="manageService('start')">Start</button>
                    <button class="btn btn-sm btn-warning" onclick="manageService('restart')">Restart</button>
                    <button class="btn btn-sm btn-danger" onclick="manageService('stop')">Stop</button>
                </div>
            </div>

            <div class="card bg-light p-3 mt-3">
                <h6>üìÅ ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Anti-Backdoor/Malware Check)</h6>
                <div class="input-group">
                    <span class="input-group-text">‡πÉ‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span>
                    <input type="number" class="form-control" id="daysInput" value="1" min="1" style="max-width: 80px;">
                    <span class="input-group-text">‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                    <button class="btn btn-primary" onclick="scanLatestFiles()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
                </div>
            </div>

            <hr>

            <div id="resultContainer" class="mt-4 d-none">
                <h5>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <span id="targetName" class="text-primary"></span></h5>
                <div id="scanResults">
                    </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const API_HOST = window.location.hostname;
    const LISTEN_PORT = 8989; 
    
    // API Endpoints
    const EXTERNAL_API_URL = `http://${API_HOST}:${LISTEN_PORT}/api/scan/external`; 
    const INTERNAL_API_URL = `http://${API_HOST}:${LISTEN_PORT}/api/scan/internal`; 
    const SERVICE_API_URL = `http://${API_HOST}:${LISTEN_PORT}/api/manage/service`;
    const FILES_API_URL = `http://${API_HOST}:${LISTEN_PORT}/api/scan/latest_files`;
    
    // Basic Auth Credentials
    const AUTH_USERNAME = 'root'; 
    const AUTH_PASSWORD = 'BossHubRoot'; 
    const AUTH_TOKEN = 'Basic ' + btoa(AUTH_USERNAME + ':' + AUTH_PASSWORD); 
    
    // DOM Elements
    const form = document.getElementById('scanForm');
    const targetInput = document.getElementById('targetInput');
    const resultContainer = document.getElementById('resultContainer');
    const scanResults = document.getElementById('scanResults');
    const targetName = document.getElementById('targetName');
    const scanBtn = document.getElementById('scanBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');

    // Helper function to toggle button state
    function toggleButton(isScanning) {
        scanBtn.disabled = isScanning;
        if (isScanning) {
            btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...';
            spinner.classList.remove('d-none');
        } else {
            btnText.textContent = '‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (Full Scan)';
            spinner.classList.add('d-none');
        }
    }

    // Generic fetch handler with Auth
    async function apiFetch(url, method = 'GET', body = null) {
        const options = {
            method: method,
            headers: {
                'Authorization': AUTH_TOKEN 
            }
        };

        if (body) {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }

        const response = await fetch(url, options);

        if (response.status === 401) {
            throw new Error("Authentication Failed: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Username/Password (root:BossHubRoot)");
        }
        
        const data = await response.json();

        if (!response.ok || data.status === 'failed' || data.error) {
            throw new Error(data.error || data.details || "Unknown API Error");
        }

        return data;
    }

    // --- 1. External Scan Logic ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const target = targetInput.value.trim();
        if (!target) return;

        targetName.textContent = target;
        scanResults.innerHTML = '<p class="text-warning">‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô Full Port (1-65535) ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>';
        resultContainer.classList.remove('d-none');
        toggleButton(true);

        try {
            const data = await apiFetch(EXTERNAL_API_URL, 'POST', { target: target });
            scanResults.innerHTML = formatExternalResults(data);
        } catch (error) {
            scanResults.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Service ‡πÅ‡∏•‡∏∞ Port 8989</div>`;
        } finally {
            toggleButton(false);
        }
    });

    // --- 2. Internal Check Logic ---
    async function runInternalCheck() {
        targetName.textContent = API_HOST;
        scanResults.innerHTML = '<p class="text-warning">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô...</p>';
        resultContainer.classList.remove('d-none');

        try {
            const data = await apiFetch(INTERNAL_API_URL, 'GET');
            scanResults.innerHTML = formatInternalResults(data);
        } catch (error) {
            scanResults.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
        }
    }

    // --- 3. Service Management Logic ---
    async function manageService(action) {
        const serviceName = document.getElementById('serviceNameInput').value.trim();
        if (!serviceName) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Service ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£!");
            return;
        }

        targetName.textContent = `Service: ${serviceName}`;
        scanResults.innerHTML = `<p class="text-warning">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ${action} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${serviceName}...</p>`;
        resultContainer.classList.remove('d-none');

        try {
            const data = await apiFetch(SERVICE_API_URL, 'POST', { service: serviceName, action: action });
            
            if (action === 'status') {
                scanResults.innerHTML = `
                    <h6>‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Service: ${serviceName}</h6>
                    <pre>${data.summary}</pre>
                    <button class="btn btn-sm btn-outline-secondary mt-2" data-bs-toggle="collapse" data-bs-target="#fullStatusOutput">‡∏î‡∏π Output ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <div class="collapse mt-2" id="fullStatusOutput">
                        <pre>${data.full_output}</pre>
                    </div>
                `;
            } else {
                scanResults.innerHTML = `<div class="alert alert-success"><strong>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</strong> ${data.message}</div>`;
            }

        } catch (error) {
            scanResults.innerHTML = `<div class="alert alert-danger"><strong>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Service ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:</strong> ${error.message}</div>`;
        }
    }


    // --- 4. Latest Files Scan Logic ---
    async function scanLatestFiles() {
        const days = document.getElementById('daysInput').value;
        
        targetName.textContent = `‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô ${days} ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`;
        scanResults.innerHTML = '<p class="text-warning">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á find ‡∏ö‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>';
        resultContainer.classList.remove('d-none');

        try {
            const data = await apiFetch(FILES_API_URL, 'POST', { days: parseInt(days) });
            
            const fileList = data.files.join('\n');
            
            scanResults.innerHTML = `
                <h6>‚úÖ ‡∏û‡∏ö ${data.file_count} ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô ${data.days} ‡∏ß‡∏±‡∏ô</h6>
                <p class="text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</p>
                <pre>${fileList || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç'}</pre>
            `;

        } catch (error) {
            scanResults.innerHTML = `<div class="alert alert-danger"><strong>‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:</strong> ${error.message}</div>`;
        }
    }

    // --- Result Formatting Functions ---

    function formatExternalResults(data) {
        let html = '';
        
        const hostStatus = Object.values(data)[0]; 
        const status = hostStatus.status === 'up' ? 
            `<span class="badge bg-success">ONLINE (Host State: ${hostStatus.status})</span>` : 
            `<span class="badge bg-danger">OFFLINE (Host State: ${hostStatus.status})</span>`;
            
        html += `<h6>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${status}</h6>`;
        
        // Ports and Services
        if (hostStatus.ports && hostStatus.ports.length > 0) {
            html += `<h6 class="mt-3">1. & 5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Port (${hostStatus.ports.length} ports open) ‡πÅ‡∏•‡∏∞ Service ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</h6>`;
            html += `<table class="table table-sm table-striped"><thead><tr><th>Port</th><th>State</th><th>Service</th><th>Product / Version</th></tr></thead><tbody>`;
            hostStatus.ports.forEach(p => {
                html += `<tr>
                    <td><strong>${p.port}</strong></td>
                    <td><span class="badge ${p.state === 'open' ? 'bg-success' : 'bg-warning'}">${p.state}</span></td>
                    <td>${p.service}</td>
                    <td>${p.product} ${p.version}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
        } else {
            html += `<div class="alert alert-info mt-3">‡πÑ‡∏°‡πà‡∏û‡∏ö Port ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div>`;
        }

        // Security Headers
        if (hostStatus.security_headers && hostStatus.security_headers.length > 0) {
            html += `<h6 class="mt-3">4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Headers (‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)</h6>`;
            html += `<pre>${hostStatus.security_headers.join('\n')}</pre>`;
        }
        
        return html;
    }

    function formatInternalResults(data) {
        let html = '';

        // 2. User Check
        html += `<h6 class="mt-3">2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö User ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà</h6>`;
        if (data.logged_in_users && data.logged_in_users.length > 0) {
            html += `<pre>${data.logged_in_users.join('\n')}</pre>`;
        } else {
             html += `<div class="alert alert-success">‡πÑ‡∏°‡πà‡∏û‡∏ö User ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
        }

        // 3. Cryptominer Check
        html += `<h6 class="mt-3">3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏ö‡∏Ç‡∏∏‡∏î‡∏ö‡∏¥‡∏ï‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå (‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ CPU ‡∏™‡∏π‡∏á)</h6>`;
        if (data.high_cpu_processes && data.high_cpu_processes.length > 0) {
            html += `<div class="alert alert-warning"><strong>‡∏û‡∏ö Process ‡πÉ‡∏ä‡πâ CPU ‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥!</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:`;
            html += `<table class="table table-sm mt-2"><thead><tr><th>PID</th><th>Process Name</th><th>CPU %</th><th>Type</th></tr></thead><tbody>`;
            data.high_cpu_processes.forEach(p => {
                html += `<tr class="${p.type === 'Potential Miner' ? 'table-danger' : ''}">
                    <td>${p.pid}</td>
                    <td>${p.name}</td>
                    <td>${p.cpu_percent}%</td>
                    <td>${p.type}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            html += `<div class="alert alert-success">‡πÑ‡∏°‡πà‡∏û‡∏ö Process ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ CPU ‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
        }

        // 6. Dangerous File Note
        html += `<h6 class="mt-3">6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</h6>`;
        html += `<div class="alert alert-info">${data.security_note}</div>`;

        return html;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
