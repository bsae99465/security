<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BossHub Ultimate Guardian (TH)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Sarabun', sans-serif; }
        .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 20px; }
        .nav-tabs .nav-link { color: #aaa; }
        .nav-tabs .nav-link.active { background-color: #1e1e1e; color: #0d6efd; border-color: #333 #333 #1e1e1e; }
        .table-dark { --bs-table-bg: #1e1e1e; }
        pre { background: #000; color: #0f0; padding: 10px; border-radius: 5px; border: 1px solid #333; max-height: 200px; overflow-y: auto;}
        .stat-val { font-size: 1.5rem; font-weight: bold; }
        .text-neon { color: #00ff41; }
        .btn-action { min-width: 120px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-black border-bottom border-secondary mb-3">
    <div class="container">
        <span class="navbar-brand text-neon"><i class="bi bi-shield-lock"></i> BossHub Ultimate Guardian</span>
        <span class="text-white small">Root:BossHubRoot | Port 8989</span>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard">แดชบอร์ดระบบ</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#threats">จัดการภัยคุกคาม (Threat Hunter)</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tools">เครื่องมือแอดมิน</button></li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="dashboard">
            <div class="row text-center mb-3">
                <div class="col-md-3"><div class="card p-3"><span class="text-muted">CPU</span><div class="stat-val" id="cpuVal">-</div></div></div>
                <div class="col-md-3"><div class="card p-3"><span class="text-muted">RAM</span><div class="stat-val" id="ramVal">-</div></div></div>
                <div class="col-md-3"><div class="card p-3"><span class="text-muted">เวลาทำงาน</span><div id="uptimeVal">-</div></div></div>
                <div class="col-md-3"><div class="card p-3"><span class="text-muted">ระบบปฏิบัติการ</span><div id="osVal">-</div></div></div>
            </div>
            <div class="row">
                <div class="col-md-6"><div class="card h-100"><div class="card-header bg-primary text-white">พื้นที่ดิสก์ & เครือข่าย</div><div class="card-body" id="diskNetBody">กำลังโหลด...</div></div></div>
                <div class="col-md-6"><div class="card h-100"><div class="card-header bg-danger text-white">ความปลอดภัยเบื้องต้น</div><div class="card-body"><h6>สถานะ Firewall (UFW)</h6><pre id="firewallOut">-</pre><h6>ประวัติการล็อกอินล่าสุด</h6><ul class="list-group list-group-flush small" id="logList"></ul></div></div></div>
            </div>
        </div>

        <div class="tab-pane fade" id="threats">
            <div class="card border-warning">
                <div class="card-header text-warning"><i class="bi bi-router"></i> ภัยคุกคามทางเครือข่าย (Network Threats)</div>
                <div class="card-body">
                    <button class="btn btn-warning btn-sm mb-2" onclick="scanNetwork()">สแกนการเชื่อมต่อที่อันตราย</button>
                    <div class="table-responsive"><table class="table table-dark table-sm"><tbody id="netThreatBody"><tr><td>กดปุ่มเพื่อเริ่มสแกน...</td></tr></tbody></table></div>
                </div>
            </div>
            <div class="card border-danger mt-3">
                <div class="card-header text-danger"><i class="bi bi-bug"></i> สแกนและจัดการสคริปต์อันตราย (Malware Scanner)</div>
                <div class="card-body">
                    <div class="input-group mb-2">
                        <span class="input-group-text bg-dark text-light">โฟลเดอร์เป้าหมาย</span>
                        <input type="text" class="form-control bg-dark text-light" id="malwarePath" value="/home">
                        <button class="btn btn-danger" onclick="scanMalware()">เริ่มสแกนเชิงลึก</button>
                    </div>
                    <div id="malwareResult"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tools">
            <div class="row">
                <div class="col-md-6"><div class="card"><div class="card-header">Nmap Port Scanner</div><div class="card-body"><input type="text" class="form-control mb-2" id="nmapTarget" placeholder="IP Address / Domain"><button class="btn btn-primary btn-sm" onclick="runNmap()">เริ่มสแกน</button><pre id="nmapOut" class="mt-2"></pre></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header">จัดการ Service (Systemd)</div><div class="card-body"><input type="text" class="form-control mb-2" id="srvName" placeholder="ชื่อ Service (เช่น apache2, nginx)"><button class="btn btn-success btn-sm" onclick="srvAction('start')">Start</button> <button class="btn btn-danger btn-sm" onclick="srvAction('stop')">Stop</button><pre id="srvOut" class="mt-2"></pre></div></div></div>
            </div>
            <div class="card"><div class="card-header">ตรวจสอบไฟล์ที่มีการแก้ไขล่าสุด (24 ชม.)</div><div class="card-body"><button class="btn btn-info btn-sm" onclick="scanFiles()">ค้นหาไฟล์</button><pre id="filesOut" class="mt-2"></pre></div></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = `http://${location.hostname}:8989/api`;
    const AUTH = { headers: { 'Authorization': 'Basic ' + btoa('root:BossHubRoot'), 'Content-Type': 'application/json' } };

    async function get(endpoint) { const r = await fetch(API+endpoint, AUTH); return r.json(); }
    async function post(endpoint, data) { const r = await fetch(API+endpoint, { ...AUTH, method: 'POST', body: JSON.stringify(data)}); return r.json(); }

    // --- Dashboard ---
    async function refreshDashboard() {
        const sys = await get('/stats');
        document.getElementById('cpuVal').innerText = sys.cpu.percent + '%';
        document.getElementById('ramVal').innerText = sys.ram.percent + '%';
        document.getElementById('uptimeVal').innerText = sys.uptime;
        document.getElementById('osVal').innerText = sys.os.split(' ')[0];
        
        let dHtml = ''; sys.disk.forEach(d => dHtml += `<div class="d-flex justify-content-between small"><span>${d.mount}</span><span>${d.percent}%</span></div>`);
        dHtml += '<hr>'; for(let k in sys.network) dHtml += `<small class="d-block text-info">${k}: ${sys.network[k]}</small>`;
        document.getElementById('diskNetBody').innerHTML = dHtml;

        const sec = await get('/security_basic');
        document.getElementById('firewallOut').innerText = sec.firewall;
        document.getElementById('logList').innerHTML = sec.logs.map(l => `<li class="list-group-item bg-dark text-light border-secondary py-1">${l}</li>`).join('');
    }

    // --- Threat Hunter ---
    async function scanNetwork() {
        const t = document.getElementById('netThreatBody'); t.innerHTML = '<tr><td>กำลังสแกน...</td></tr>';
        const res = await get('/threats/network');
        if(res.length === 0) return t.innerHTML = '<tr><td class="text-success">ไม่พบการเชื่อมต่อที่อันตราย</td></tr>';
        t.innerHTML = '';
        res.forEach(r => t.innerHTML += `<tr class="table-danger"><td>${r.pid}</td><td>${r.raddr}</td><td>${r.risk}</td><td>${r.reasons}</td></tr>`);
    }

    async function scanMalware() {
        const div = document.getElementById('malwareResult');
        div.innerHTML = '<div class="spinner-border text-danger spinner-border-sm"></div> กำลังสแกนไฟล์...';
        const res = await get('/threats/malware?path=' + document.getElementById('malwarePath').value);
        if(res.error) return div.innerText = res.error;
        
        let h = `<p class="mt-2 mb-1">สแกนแล้ว: ${res.scanned} ไฟล์ | พบความเสี่ยง: <span class="badge bg-danger">${res.infected.length}</span></p>`;
        
        if(res.infected.length === 0) {
            h += '<div class="alert alert-success">ไม่พบไฟล์อันตราย</div>';
        } else {
            res.infected.forEach(f => {
                const isQuarantined = f.status === 'quarantined';
                const statusBadge = isQuarantined 
                    ? '<span class="badge bg-success">แก้ไขแล้ว (Quarantined)</span>' 
                    : '<span class="badge bg-danger">อันตราย (Active)</span>';
                
                const btnAction = isQuarantined
                    ? `<button class="btn btn-outline-info btn-sm btn-action" onclick="manageFile('${f.path}', 'restore')"><i class="bi bi-arrow-counterclockwise"></i> คืนค่าไฟล์เดิม</button>`
                    : `<button class="btn btn-outline-warning btn-sm btn-action" onclick="manageFile('${f.path}', 'fix')"><i class="bi bi-bandaid"></i> ปิดตายไฟล์นี้</button>`;

                h += `<div class="alert alert-dark border-${isQuarantined ? 'success' : 'danger'} small py-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${f.path}</strong> ${statusBadge}<br>
                                <span class="text-muted">${f.threats.join(', ')}</span>
                            </div>
                            ${btnAction}
                        </div>
                      </div>`;
            });
        }
        div.innerHTML = h;
    }

    async function manageFile(path, action) {
        let confirmMsg = action === 'fix' 
            ? 'ยืนยันที่จะ "ปิดตาย" ไฟล์นี้?\n(ระบบจะใส่ Comment ปิดโค้ดทั้งหมด เพื่อไม่ให้ทำงานได้)' 
            : 'ยืนยันที่จะ "คืนค่า" ไฟล์นี้กลับสู่สภาพเดิม?';
            
        if(!confirm(confirmMsg)) return;
        
        const res = await post('/threats/manage_file', { path: path, action: action });
        alert(res.message);
        scanMalware(); // Rescan to update UI Status
    }

    // --- Tools ---
    async function runNmap() {
        document.getElementById('nmapOut').innerText = 'กำลังสแกน...';
        const res = await post('/tools/nmap', {target: document.getElementById('nmapTarget').value});
        let txt = `สถานะ: ${res.status}\n`; res.ports.forEach(p => txt += `Port ${p.port}: ${p.state} (${p.service})\n`);
        document.getElementById('nmapOut').innerText = txt;
    }

    async function srvAction(act) {
        document.getElementById('srvOut').innerText = 'กำลังดำเนินการ...';
        const res = await post('/tools/service', {service: document.getElementById('srvName').value, action: act});
        document.getElementById('srvOut').innerText = res.output || res.error || 'เสร็จสิ้น';
    }

    async function scanFiles() {
        document.getElementById('filesOut').innerText = 'กำลังค้นหา...';
        const res = await post('/tools/files', {days: 1});
        document.getElementById('filesOut').innerText = res.files.join('\n') || 'ไม่พบไฟล์ในช่วงเวลาดังกล่าว';
    }

    // Init
    refreshDashboard();
    setInterval(refreshDashboard, 30000);
</script>
</body>
</html>
